8fe467b4220a3a17ed302c84dac62c72
'use strict';

var BatchedBridge = require("../BatchedBridge/BatchedBridge");

var EventEmitter = require("../vendor/emitter/EventEmitter");

var TaskQueue = require("./TaskQueue");

var infoLog = require("../Utilities/infoLog");

var invariant = require('invariant');

var keyMirror = require('fbjs/lib/keyMirror');

var _emitter = new EventEmitter();

var DEBUG_DELAY = 0;
var DEBUG = false;
var InteractionManager = {
  Events: keyMirror({
    interactionStart: true,
    interactionComplete: true
  }),
  runAfterInteractions: function runAfterInteractions(task) {
    var tasks = [];
    var promise = new Promise(function (resolve) {
      _scheduleUpdate();

      if (task) {
        tasks.push(task);
      }

      tasks.push({
        run: resolve,
        name: 'resolve ' + (task && task.name || '?')
      });

      _taskQueue.enqueueTasks(tasks);
    });
    return {
      then: promise.then.bind(promise),
      done: function done() {
        if (promise.done) {
          return promise.done.apply(promise, arguments);
        } else {
          console.warn('Tried to call done when not supported by current Promise implementation.');
        }
      },
      cancel: function cancel() {
        _taskQueue.cancelTasks(tasks);
      }
    };
  },
  createInteractionHandle: function createInteractionHandle() {
    DEBUG && infoLog('create interaction handle');

    _scheduleUpdate();

    var handle = ++_inc;

    _addInteractionSet.add(handle);

    return handle;
  },
  clearInteractionHandle: function clearInteractionHandle(handle) {
    DEBUG && infoLog('clear interaction handle');
    invariant(!!handle, 'Must provide a handle to clear.');

    _scheduleUpdate();

    _addInteractionSet.delete(handle);

    _deleteInteractionSet.add(handle);
  },
  addListener: _emitter.addListener.bind(_emitter),
  setDeadline: function setDeadline(deadline) {
    _deadline = deadline;
  }
};

var _interactionSet = new Set();

var _addInteractionSet = new Set();

var _deleteInteractionSet = new Set();

var _taskQueue = new TaskQueue({
  onMoreTasks: _scheduleUpdate
});

var _nextUpdateHandle = 0;
var _inc = 0;

var _deadline = -1;

function _scheduleUpdate() {
  if (!_nextUpdateHandle) {
    if (_deadline > 0) {
      _nextUpdateHandle = setTimeout(_processUpdate, 0 + DEBUG_DELAY);
    } else {
      _nextUpdateHandle = setImmediate(_processUpdate);
    }
  }
}

function _processUpdate() {
  _nextUpdateHandle = 0;
  var interactionCount = _interactionSet.size;

  _addInteractionSet.forEach(function (handle) {
    return _interactionSet.add(handle);
  });

  _deleteInteractionSet.forEach(function (handle) {
    return _interactionSet.delete(handle);
  });

  var nextInteractionCount = _interactionSet.size;

  if (interactionCount !== 0 && nextInteractionCount === 0) {
    _emitter.emit(InteractionManager.Events.interactionComplete);
  } else if (interactionCount === 0 && nextInteractionCount !== 0) {
    _emitter.emit(InteractionManager.Events.interactionStart);
  }

  if (nextInteractionCount === 0) {
    while (_taskQueue.hasTasksToProcess()) {
      _taskQueue.processNext();

      if (_deadline > 0 && BatchedBridge.getEventLoopRunningTime() >= _deadline) {
        _scheduleUpdate();

        break;
      }
    }
  }

  _addInteractionSet.clear();

  _deleteInteractionSet.clear();
}

module.exports = InteractionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkludGVyYWN0aW9uTWFuYWdlci5qcyJdLCJuYW1lcyI6WyJCYXRjaGVkQnJpZGdlIiwicmVxdWlyZSIsIkV2ZW50RW1pdHRlciIsIlRhc2tRdWV1ZSIsImluZm9Mb2ciLCJpbnZhcmlhbnQiLCJrZXlNaXJyb3IiLCJfZW1pdHRlciIsIkRFQlVHX0RFTEFZIiwiREVCVUciLCJJbnRlcmFjdGlvbk1hbmFnZXIiLCJFdmVudHMiLCJpbnRlcmFjdGlvblN0YXJ0IiwiaW50ZXJhY3Rpb25Db21wbGV0ZSIsInJ1bkFmdGVySW50ZXJhY3Rpb25zIiwidGFzayIsInRhc2tzIiwicHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlIiwiX3NjaGVkdWxlVXBkYXRlIiwicHVzaCIsInJ1biIsIm5hbWUiLCJfdGFza1F1ZXVlIiwiZW5xdWV1ZVRhc2tzIiwidGhlbiIsImJpbmQiLCJkb25lIiwiY29uc29sZSIsIndhcm4iLCJjYW5jZWwiLCJjYW5jZWxUYXNrcyIsImNyZWF0ZUludGVyYWN0aW9uSGFuZGxlIiwiaGFuZGxlIiwiX2luYyIsIl9hZGRJbnRlcmFjdGlvblNldCIsImFkZCIsImNsZWFySW50ZXJhY3Rpb25IYW5kbGUiLCJkZWxldGUiLCJfZGVsZXRlSW50ZXJhY3Rpb25TZXQiLCJhZGRMaXN0ZW5lciIsInNldERlYWRsaW5lIiwiZGVhZGxpbmUiLCJfZGVhZGxpbmUiLCJfaW50ZXJhY3Rpb25TZXQiLCJTZXQiLCJvbk1vcmVUYXNrcyIsIl9uZXh0VXBkYXRlSGFuZGxlIiwic2V0VGltZW91dCIsIl9wcm9jZXNzVXBkYXRlIiwic2V0SW1tZWRpYXRlIiwiaW50ZXJhY3Rpb25Db3VudCIsInNpemUiLCJmb3JFYWNoIiwibmV4dEludGVyYWN0aW9uQ291bnQiLCJlbWl0IiwiaGFzVGFza3NUb1Byb2Nlc3MiLCJwcm9jZXNzTmV4dCIsImdldEV2ZW50TG9vcFJ1bm5pbmdUaW1lIiwiY2xlYXIiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFVQTs7QUFF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Q0FBQ1EsSUFBN0M7O0FBRUEsTUFBSUQsZ0JBQWdCLEtBQUssQ0FBckIsSUFBMEJHLG9CQUFvQixLQUFLLENBQXZELEVBQTBEO0FBRXhEaEQsSUFBQUEsUUFBUSxDQUFDaUQsSUFBVCxDQUFjOUMsa0JBQWtCLENBQUNDLE1BQW5CLENBQTBCRSxtQkFBeEM7QUFDRCxHQUhELE1BR08sSUFBSXVDLGdCQUFnQixLQUFLLENBQXJCLElBQTBCRyxvQkFBb0IsS0FBSyxDQUF2RCxFQUEwRDtBQUUvRGhELElBQUFBLFFBQVEsQ0FBQ2lELElBQVQsQ0FBYzlDLGtCQUFrQixDQUFDQyxNQUFuQixDQUEwQkMsZ0JBQXhDO0FBQ0Q7O0FBR0QsTUFBSTJDLG9CQUFvQixLQUFLLENBQTdCLEVBQWdDO0FBQzlCLFdBQU8vQixVQUFVLENBQUNpQyxpQkFBWCxFQUFQLEVBQXVDO0FBQ3JDakMsTUFBQUEsVUFBVSxDQUFDa0MsV0FBWDs7QUFDQSxVQUNFZCxTQUFTLEdBQUcsQ0FBWixJQUNBNUMsYUFBYSxDQUFDMkQsdUJBQWQsTUFBMkNmLFNBRjdDLEVBR0U7QUFFQXhCLFFBQUFBLGVBQWU7O0FBQ2Y7QUFDRDtBQUNGO0FBQ0Y7O0FBQ0RnQixFQUFBQSxrQkFBa0IsQ0FBQ3dCLEtBQW5COztBQUNBcEIsRUFBQUEscUJBQXFCLENBQUNvQixLQUF0QjtBQUNEOztBQUVEQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJwRCxrQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmb3JtYXRcbiAqIEBmbG93XG4gKi9cblxuJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBCYXRjaGVkQnJpZGdlID0gcmVxdWlyZSgnLi4vQmF0Y2hlZEJyaWRnZS9CYXRjaGVkQnJpZGdlJyk7XG5jb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCcuLi92ZW5kb3IvZW1pdHRlci9FdmVudEVtaXR0ZXInKTtcbmNvbnN0IFRhc2tRdWV1ZSA9IHJlcXVpcmUoJy4vVGFza1F1ZXVlJyk7XG5cbmNvbnN0IGluZm9Mb2cgPSByZXF1aXJlKCcuLi9VdGlsaXRpZXMvaW5mb0xvZycpO1xuY29uc3QgaW52YXJpYW50ID0gcmVxdWlyZSgnaW52YXJpYW50Jyk7XG5jb25zdCBrZXlNaXJyb3IgPSByZXF1aXJlKCdmYmpzL2xpYi9rZXlNaXJyb3InKTtcblxudHlwZSBIYW5kbGUgPSBudW1iZXI7XG5pbXBvcnQgdHlwZSB7VGFza30gZnJvbSAnLi9UYXNrUXVldWUnO1xuXG5jb25zdCBfZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuY29uc3QgREVCVUdfREVMQVkgPSAwO1xuY29uc3QgREVCVUcgPSBmYWxzZTtcblxuLyoqXG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIgYWxsb3dzIGxvbmctcnVubmluZyB3b3JrIHRvIGJlIHNjaGVkdWxlZCBhZnRlciBhbnlcbiAqIGludGVyYWN0aW9ucy9hbmltYXRpb25zIGhhdmUgY29tcGxldGVkLiBJbiBwYXJ0aWN1bGFyLCB0aGlzIGFsbG93cyBKYXZhU2NyaXB0XG4gKiBhbmltYXRpb25zIHRvIHJ1biBzbW9vdGhseS5cbiAqXG4gKiBBcHBsaWNhdGlvbnMgY2FuIHNjaGVkdWxlIHRhc2tzIHRvIHJ1biBhZnRlciBpbnRlcmFjdGlvbnMgd2l0aCB0aGUgZm9sbG93aW5nOlxuICpcbiAqIGBgYFxuICogSW50ZXJhY3Rpb25NYW5hZ2VyLnJ1bkFmdGVySW50ZXJhY3Rpb25zKCgpID0+IHtcbiAqICAgLy8gLi4ubG9uZy1ydW5uaW5nIHN5bmNocm9ub3VzIHRhc2suLi5cbiAqIH0pO1xuICogYGBgXG4gKlxuICogQ29tcGFyZSB0aGlzIHRvIG90aGVyIHNjaGVkdWxpbmcgYWx0ZXJuYXRpdmVzOlxuICpcbiAqIC0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCk6IGZvciBjb2RlIHRoYXQgYW5pbWF0ZXMgYSB2aWV3IG92ZXIgdGltZS5cbiAqIC0gc2V0SW1tZWRpYXRlL3NldFRpbWVvdXQoKTogcnVuIGNvZGUgbGF0ZXIsIG5vdGUgdGhpcyBtYXkgZGVsYXkgYW5pbWF0aW9ucy5cbiAqIC0gcnVuQWZ0ZXJJbnRlcmFjdGlvbnMoKTogcnVuIGNvZGUgbGF0ZXIsIHdpdGhvdXQgZGVsYXlpbmcgYWN0aXZlIGFuaW1hdGlvbnMuXG4gKlxuICogVGhlIHRvdWNoIGhhbmRsaW5nIHN5c3RlbSBjb25zaWRlcnMgb25lIG9yIG1vcmUgYWN0aXZlIHRvdWNoZXMgdG8gYmUgYW5cbiAqICdpbnRlcmFjdGlvbicgYW5kIHdpbGwgZGVsYXkgYHJ1bkFmdGVySW50ZXJhY3Rpb25zKClgIGNhbGxiYWNrcyB1bnRpbCBhbGxcbiAqIHRvdWNoZXMgaGF2ZSBlbmRlZCBvciBiZWVuIGNhbmNlbGxlZC5cbiAqXG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIgYWxzbyBhbGxvd3MgYXBwbGljYXRpb25zIHRvIHJlZ2lzdGVyIGFuaW1hdGlvbnMgYnlcbiAqIGNyZWF0aW5nIGFuIGludGVyYWN0aW9uICdoYW5kbGUnIG9uIGFuaW1hdGlvbiBzdGFydCwgYW5kIGNsZWFyaW5nIGl0IHVwb25cbiAqIGNvbXBsZXRpb246XG4gKlxuICogYGBgXG4gKiB2YXIgaGFuZGxlID0gSW50ZXJhY3Rpb25NYW5hZ2VyLmNyZWF0ZUludGVyYWN0aW9uSGFuZGxlKCk7XG4gKiAvLyBydW4gYW5pbWF0aW9uLi4uIChgcnVuQWZ0ZXJJbnRlcmFjdGlvbnNgIHRhc2tzIGFyZSBxdWV1ZWQpXG4gKiAvLyBsYXRlciwgb24gYW5pbWF0aW9uIGNvbXBsZXRpb246XG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIuY2xlYXJJbnRlcmFjdGlvbkhhbmRsZShoYW5kbGUpO1xuICogLy8gcXVldWVkIHRhc2tzIHJ1biBpZiBhbGwgaGFuZGxlcyB3ZXJlIGNsZWFyZWRcbiAqIGBgYFxuICpcbiAqIGBydW5BZnRlckludGVyYWN0aW9uc2AgdGFrZXMgZWl0aGVyIGEgcGxhaW4gY2FsbGJhY2sgZnVuY3Rpb24sIG9yIGFcbiAqIGBQcm9taXNlVGFza2Agb2JqZWN0IHdpdGggYSBgZ2VuYCBtZXRob2QgdGhhdCByZXR1cm5zIGEgYFByb21pc2VgLiAgSWYgYVxuICogYFByb21pc2VUYXNrYCBpcyBzdXBwbGllZCwgdGhlbiBpdCBpcyBmdWxseSByZXNvbHZlZCAoaW5jbHVkaW5nIGFzeW5jaHJvbm91c1xuICogZGVwZW5kZW5jaWVzIHRoYXQgYWxzbyBzY2hlZHVsZSBtb3JlIHRhc2tzIHZpYSBgcnVuQWZ0ZXJJbnRlcmFjdGlvbnNgKSBiZWZvcmVcbiAqIHN0YXJ0aW5nIG9uIHRoZSBuZXh0IHRhc2sgdGhhdCBtaWdodCBoYXZlIGJlZW4gcXVldWVkIHVwIHN5bmNocm9ub3VzbHlcbiAqIGVhcmxpZXIuXG4gKlxuICogQnkgZGVmYXVsdCwgcXVldWVkIHRhc2tzIGFyZSBleGVjdXRlZCB0b2dldGhlciBpbiBhIGxvb3AgaW4gb25lXG4gKiBgc2V0SW1tZWRpYXRlYCBiYXRjaC4gSWYgYHNldERlYWRsaW5lYCBpcyBjYWxsZWQgd2l0aCBhIHBvc2l0aXZlIG51bWJlciwgdGhlblxuICogdGFza3Mgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIHVudGlsIHRoZSBkZWFkbGluZSAoaW4gdGVybXMgb2YganMgZXZlbnQgbG9vcCBydW5cbiAqIHRpbWUpIGFwcHJvYWNoZXMsIGF0IHdoaWNoIHBvaW50IGV4ZWN1dGlvbiB3aWxsIHlpZWxkIHZpYSBzZXRUaW1lb3V0LFxuICogYWxsb3dpbmcgZXZlbnRzIHN1Y2ggYXMgdG91Y2hlcyB0byBzdGFydCBpbnRlcmFjdGlvbnMgYW5kIGJsb2NrIHF1ZXVlZCB0YXNrc1xuICogZnJvbSBleGVjdXRpbmcsIG1ha2luZyBhcHBzIG1vcmUgcmVzcG9uc2l2ZS5cbiAqL1xuY29uc3QgSW50ZXJhY3Rpb25NYW5hZ2VyID0ge1xuICBFdmVudHM6IGtleU1pcnJvcih7XG4gICAgaW50ZXJhY3Rpb25TdGFydDogdHJ1ZSxcbiAgICBpbnRlcmFjdGlvbkNvbXBsZXRlOiB0cnVlLFxuICB9KSxcblxuICAvKipcbiAgICogU2NoZWR1bGUgYSBmdW5jdGlvbiB0byBydW4gYWZ0ZXIgYWxsIGludGVyYWN0aW9ucyBoYXZlIGNvbXBsZXRlZC4gUmV0dXJucyBhIGNhbmNlbGxhYmxlXG4gICAqIFwicHJvbWlzZVwiLlxuICAgKi9cbiAgcnVuQWZ0ZXJJbnRlcmFjdGlvbnMoXG4gICAgdGFzazogP1Rhc2ssXG4gICk6IHt0aGVuOiBGdW5jdGlvbiwgZG9uZTogRnVuY3Rpb24sIGNhbmNlbDogRnVuY3Rpb259IHtcbiAgICBjb25zdCB0YXNrcyA9IFtdO1xuICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgIF9zY2hlZHVsZVVwZGF0ZSgpO1xuICAgICAgaWYgKHRhc2spIHtcbiAgICAgICAgdGFza3MucHVzaCh0YXNrKTtcbiAgICAgIH1cbiAgICAgIHRhc2tzLnB1c2goe1xuICAgICAgICBydW46IHJlc29sdmUsXG4gICAgICAgIG5hbWU6ICdyZXNvbHZlICcgKyAoKHRhc2sgJiYgdGFzay5uYW1lKSB8fCAnPycpLFxuICAgICAgfSk7XG4gICAgICBfdGFza1F1ZXVlLmVucXVldWVUYXNrcyh0YXNrcyk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRoZW46IHByb21pc2UudGhlbi5iaW5kKHByb21pc2UpLFxuICAgICAgZG9uZTogKC4uLmFyZ3MpID0+IHtcbiAgICAgICAgaWYgKHByb21pc2UuZG9uZSkge1xuICAgICAgICAgIHJldHVybiBwcm9taXNlLmRvbmUoLi4uYXJncyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgICAgJ1RyaWVkIHRvIGNhbGwgZG9uZSB3aGVuIG5vdCBzdXBwb3J0ZWQgYnkgY3VycmVudCBQcm9taXNlIGltcGxlbWVudGF0aW9uLicsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIGNhbmNlbDogZnVuY3Rpb24oKSB7XG4gICAgICAgIF90YXNrUXVldWUuY2FuY2VsVGFza3ModGFza3MpO1xuICAgICAgfSxcbiAgICB9O1xuICB9LFxuXG4gIC8qKlxuICAgKiBOb3RpZnkgbWFuYWdlciB0aGF0IGFuIGludGVyYWN0aW9uIGhhcyBzdGFydGVkLlxuICAgKi9cbiAgY3JlYXRlSW50ZXJhY3Rpb25IYW5kbGUoKTogSGFuZGxlIHtcbiAgICBERUJVRyAmJiBpbmZvTG9nKCdjcmVhdGUgaW50ZXJhY3Rpb24gaGFuZGxlJyk7XG4gICAgX3NjaGVkdWxlVXBkYXRlKCk7XG4gICAgY29uc3QgaGFuZGxlID0gKytfaW5jO1xuICAgIF9hZGRJbnRlcmFjdGlvblNldC5hZGQoaGFuZGxlKTtcbiAgICByZXR1cm4gaGFuZGxlO1xuICB9LFxuXG4gIC8qKlxuICAgKiBOb3RpZnkgbWFuYWdlciB0aGF0IGFuIGludGVyYWN0aW9uIGhhcyBjb21wbGV0ZWQuXG4gICAqL1xuICBjbGVhckludGVyYWN0aW9uSGFuZGxlKGhhbmRsZTogSGFuZGxlKSB7XG4gICAgREVCVUcgJiYgaW5mb0xvZygnY2xlYXIgaW50ZXJhY3Rpb24gaGFuZGxlJyk7XG4gICAgaW52YXJpYW50KCEhaGFuZGxlLCAnTXVzdCBwcm92aWRlIGEgaGFuZGxlIHRvIGNsZWFyLicpO1xuICAgIF9zY2hlZHVsZVVwZGF0ZSgpO1xuICAgIF9hZGRJbnRlcmFjdGlvblNldC5kZWxldGUoaGFuZGxlKTtcbiAgICBfZGVsZXRlSW50ZXJhY3Rpb25TZXQuYWRkKGhhbmRsZSk7XG4gIH0sXG5cbiAgYWRkTGlzdGVuZXI6IF9lbWl0dGVyLmFkZExpc3RlbmVyLmJpbmQoX2VtaXR0ZXIpLFxuXG4gIC8qKlxuICAgKiBBIHBvc2l0aXZlIG51bWJlciB3aWxsIHVzZSBzZXRUaW1lb3V0IHRvIHNjaGVkdWxlIGFueSB0YXNrcyBhZnRlciB0aGVcbiAgICogZXZlbnRMb29wUnVubmluZ1RpbWUgaGl0cyB0aGUgZGVhZGxpbmUgdmFsdWUsIG90aGVyd2lzZSBhbGwgdGFza3Mgd2lsbCBiZVxuICAgKiBleGVjdXRlZCBpbiBvbmUgc2V0SW1tZWRpYXRlIGJhdGNoIChkZWZhdWx0KS5cbiAgICovXG4gIHNldERlYWRsaW5lKGRlYWRsaW5lOiBudW1iZXIpIHtcbiAgICBfZGVhZGxpbmUgPSBkZWFkbGluZTtcbiAgfSxcbn07XG5cbmNvbnN0IF9pbnRlcmFjdGlvblNldCA9IG5ldyBTZXQoKTtcbmNvbnN0IF9hZGRJbnRlcmFjdGlvblNldCA9IG5ldyBTZXQoKTtcbmNvbnN0IF9kZWxldGVJbnRlcmFjdGlvblNldCA9IG5ldyBTZXQoKTtcbmNvbnN0IF90YXNrUXVldWUgPSBuZXcgVGFza1F1ZXVlKHtvbk1vcmVUYXNrczogX3NjaGVkdWxlVXBkYXRlfSk7XG5sZXQgX25leHRVcGRhdGVIYW5kbGUgPSAwO1xubGV0IF9pbmMgPSAwO1xubGV0IF9kZWFkbGluZSA9IC0xO1xuXG5kZWNsYXJlIGZ1bmN0aW9uIHNldEltbWVkaWF0ZShjYWxsYmFjazogYW55LCAuLi5hcmdzOiBBcnJheTxhbnk+KTogbnVtYmVyO1xuXG4vKipcbiAqIFNjaGVkdWxlIGFuIGFzeW5jaHJvbm91cyB1cGRhdGUgdG8gdGhlIGludGVyYWN0aW9uIHN0YXRlLlxuICovXG5mdW5jdGlvbiBfc2NoZWR1bGVVcGRhdGUoKSB7XG4gIGlmICghX25leHRVcGRhdGVIYW5kbGUpIHtcbiAgICBpZiAoX2RlYWRsaW5lID4gMCkge1xuICAgICAgLyogJEZsb3dGaXhNZSg+PTAuNjMuMCBzaXRlPXJlYWN0X25hdGl2ZV9mYikgVGhpcyBjb21tZW50IHN1cHByZXNzZXMgYW5cbiAgICAgICAqIGVycm9yIGZvdW5kIHdoZW4gRmxvdyB2MC42MyB3YXMgZGVwbG95ZWQuIFRvIHNlZSB0aGUgZXJyb3IgZGVsZXRlIHRoaXNcbiAgICAgICAqIGNvbW1lbnQgYW5kIHJ1biBGbG93LiAqL1xuICAgICAgX25leHRVcGRhdGVIYW5kbGUgPSBzZXRUaW1lb3V0KF9wcm9jZXNzVXBkYXRlLCAwICsgREVCVUdfREVMQVkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBfbmV4dFVwZGF0ZUhhbmRsZSA9IHNldEltbWVkaWF0ZShfcHJvY2Vzc1VwZGF0ZSk7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogTm90aWZ5IGxpc3RlbmVycywgcHJvY2VzcyBxdWV1ZSwgZXRjXG4gKi9cbmZ1bmN0aW9uIF9wcm9jZXNzVXBkYXRlKCkge1xuICBfbmV4dFVwZGF0ZUhhbmRsZSA9IDA7XG5cbiAgY29uc3QgaW50ZXJhY3Rpb25Db3VudCA9IF9pbnRlcmFjdGlvblNldC5zaXplO1xuICBfYWRkSW50ZXJhY3Rpb25TZXQuZm9yRWFjaChoYW5kbGUgPT4gX2ludGVyYWN0aW9uU2V0LmFkZChoYW5kbGUpKTtcbiAgX2RlbGV0ZUludGVyYWN0aW9uU2V0LmZvckVhY2goaGFuZGxlID0+IF9pbnRlcmFjdGlvblNldC5kZWxldGUoaGFuZGxlKSk7XG4gIGNvbnN0IG5leHRJbnRlcmFjdGlvbkNvdW50ID0gX2ludGVyYWN0aW9uU2V0LnNpemU7XG5cbiAgaWYgKGludGVyYWN0aW9uQ291bnQgIT09IDAgJiYgbmV4dEludGVyYWN0aW9uQ291bnQgPT09IDApIHtcbiAgICAvLyB0cmFuc2l0aW9uIGZyb20gMSsgLS0+IDAgaW50ZXJhY3Rpb25zXG4gICAgX2VtaXR0ZXIuZW1pdChJbnRlcmFjdGlvbk1hbmFnZXIuRXZlbnRzLmludGVyYWN0aW9uQ29tcGxldGUpO1xuICB9IGVsc2UgaWYgKGludGVyYWN0aW9uQ291bnQgPT09IDAgJiYgbmV4dEludGVyYWN0aW9uQ291bnQgIT09IDApIHtcbiAgICAvLyB0cmFuc2l0aW9uIGZyb20gMCAtLT4gMSsgaW50ZXJhY3Rpb25zXG4gICAgX2VtaXR0ZXIuZW1pdChJbnRlcmFjdGlvbk1hbmFnZXIuRXZlbnRzLmludGVyYWN0aW9uU3RhcnQpO1xuICB9XG5cbiAgLy8gcHJvY2VzcyB0aGUgcXVldWUgcmVnYXJkbGVzcyBvZiBhIHRyYW5zaXRpb25cbiAgaWYgKG5leHRJbnRlcmFjdGlvbkNvdW50ID09PSAwKSB7XG4gICAgd2hpbGUgKF90YXNrUXVldWUuaGFzVGFza3NUb1Byb2Nlc3MoKSkge1xuICAgICAgX3Rhc2tRdWV1ZS5wcm9jZXNzTmV4dCgpO1xuICAgICAgaWYgKFxuICAgICAgICBfZGVhZGxpbmUgPiAwICYmXG4gICAgICAgIEJhdGNoZWRCcmlkZ2UuZ2V0RXZlbnRMb29wUnVubmluZ1RpbWUoKSA+PSBfZGVhZGxpbmVcbiAgICAgICkge1xuICAgICAgICAvLyBIaXQgZGVhZGxpbmUgYmVmb3JlIHByb2Nlc3NpbmcgYWxsIHRhc2tzLCBzbyBwcm9jZXNzIG1vcmUgbGF0ZXIuXG4gICAgICAgIF9zY2hlZHVsZVVwZGF0ZSgpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgX2FkZEludGVyYWN0aW9uU2V0LmNsZWFyKCk7XG4gIF9kZWxldGVJbnRlcmFjdGlvblNldC5jbGVhcigpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEludGVyYWN0aW9uTWFuYWdlcjtcbiJdfQ==